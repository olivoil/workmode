#!/usr/bin/env bash
# workmode — Main CLI entrypoint (two-level dispatcher)
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")/.." && pwd)"
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/cli.sh"
source "$SCRIPT_DIR/lib/sessions.sh"

BIN_DIR="$SCRIPT_DIR/bin"
STATE_DIR="$(config_state_dir)"
HISTORY_FILE="$STATE_DIR/history.jsonl"
LOG_DIR="$STATE_DIR/logs"
WATCHER_SERVICE="workmode-watcher"
CONFIG_WATCHER="workmode-config-watcher"
UNIT_PREFIX="workmode-trigger-"

VERSION="0.2.0"

usage() {
    cat <<EOF
workmode $VERSION — Automated Claude Code skill runner

Usage: workmode <command> [options]

Lifecycle:
  on                    Activate all triggers
  off                   Deactivate all triggers
  status [--json]       Show current state and summary

Triggers:
  trigger list [--json]          List configured triggers
  trigger show <name> [--json]   Show trigger config
  trigger run <name>             Manually run a trigger
  trigger enable <name>          Enable a trigger's systemd unit
  trigger disable <name>         Disable a trigger's systemd unit

Sessions:
  session list [--json] [--running|--stuck|--completed]
  session logs <id>              Show session output
  session tail <id>              Follow running session
  session resume <id>            Resume interactive session
  session stop <id>              Graceful stop (SIGTERM)
  session kill <id>              Force kill (SIGKILL)

Config:
  config show [--json]           Print parsed config
  config edit                    Open in \$EDITOR
  config validate                Check syntax + required fields
  config apply                   Validate + reinstall systemd units
  config path                    Print config file path

System:
  install                        Install/update systemd units
  uninstall                      Remove systemd units
  tui                            Interactive browser (default when no args)
  completions bash|zsh|fish      Generate shell completions

  help                           Show this help
  version                        Show version

EOF
    exit 0
}

# --- Top-level commands ---

cmd_on() {
    echo "Activating workmode..."

    "$BIN_DIR/workmode-install" install
    "$BIN_DIR/workmode-install" enable

    if systemctl --user cat "$WATCHER_SERVICE" &>/dev/null; then
        systemctl --user enable "$WATCHER_SERVICE" 2>/dev/null || true
        systemctl --user start "$WATCHER_SERVICE" 2>/dev/null || true
        echo "Watcher service started."
    fi

    if systemctl --user cat "${CONFIG_WATCHER}.path" &>/dev/null; then
        systemctl --user enable "${CONFIG_WATCHER}.path" 2>/dev/null || true
        systemctl --user start "${CONFIG_WATCHER}.path" 2>/dev/null || true
        echo "Config watcher started."
    fi

    echo ""
    echo "Workmode is ON."
    cmd_status
}

cmd_off() {
    echo "Deactivating workmode..."

    if systemctl --user is-active "$WATCHER_SERVICE" &>/dev/null; then
        systemctl --user stop "$WATCHER_SERVICE"
        echo "Watcher service stopped."
    fi

    if systemctl --user is-active "${CONFIG_WATCHER}.path" &>/dev/null; then
        systemctl --user stop "${CONFIG_WATCHER}.path"
        echo "Config watcher stopped."
    fi

    "$BIN_DIR/workmode-install" disable

    echo ""
    echo "Workmode is OFF."
}

cmd_status() {
    parse_global_flags "$@"

    # Derive active state from systemd
    local active=false
    if systemctl --user is-active "$WATCHER_SERVICE" &>/dev/null; then
        active=true
    fi
    for unit_file in "$HOME/.config/systemd/user"/${UNIT_PREFIX}*.timer; do
        [[ -f "$unit_file" ]] || continue
        local unit_name
        unit_name="$(basename "$unit_file")"
        if systemctl --user is-enabled --quiet "$unit_name" 2>/dev/null; then
            active=true
            break
        fi
    done

    local watcher_running=false
    systemctl --user is-active "$WATCHER_SERVICE" &>/dev/null && watcher_running=true

    local timer_count
    timer_count="$(systemctl --user list-timers --all 2>/dev/null | grep -c "$UNIT_PREFIX" || true)"

    local trigger_count=0
    for _ in $(config_list_triggers); do
        (( ++trigger_count ))
    done

    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        local fields
        fields="$(json_field_bool "active" "$active")"
        fields+=",$(json_field_bool "watcher" "$watcher_running")"
        fields+=",$(json_field_num "timers" "$timer_count")"
        fields+=",$(json_field_num "triggers" "$trigger_count")"
        json_object "$fields"
        echo
        return
    fi

    echo ""
    if $active; then
        echo "  Status: ACTIVE"
    else
        echo "  Status: INACTIVE"
    fi

    if $watcher_running; then
        echo "  Watcher: running"
    else
        echo "  Watcher: stopped"
    fi

    echo "  Timers: $timer_count"
    echo ""

    # Show triggers summary
    source "$SCRIPT_DIR/lib/cmd/trigger.sh"
    cmd_trigger_list
}

cmd_install() {
    "$BIN_DIR/workmode-install" install
}

cmd_uninstall() {
    "$BIN_DIR/workmode-install" uninstall
}

# --- Dispatch ---
COMMAND="${1:-tui}"
shift || true

case "$COMMAND" in
    on)           cmd_on ;;
    off)          cmd_off ;;
    status)       cmd_status "$@" ;;
    trigger)      source "$SCRIPT_DIR/lib/cmd/trigger.sh"; dispatch_trigger "$@" ;;
    session)      source "$SCRIPT_DIR/lib/cmd/session.sh"; dispatch_session "$@" ;;
    config)       source "$SCRIPT_DIR/lib/cmd/config.sh"; dispatch_config "$@" ;;
    install)      cmd_install ;;
    uninstall)    cmd_uninstall ;;
    tui)
        if [[ -x "$SCRIPT_DIR/bin/workmode-tui" ]]; then
            exec "$SCRIPT_DIR/bin/workmode-tui" "$@"
        else
            source "$SCRIPT_DIR/lib/cmd/tui.sh"; cmd_tui "$@"
        fi ;;
    completions)  source "$SCRIPT_DIR/lib/cmd/completions.sh"; dispatch_completions "$@" ;;
    help|--help|-h)       usage ;;
    version|--version|-v) echo "workmode $VERSION" ;;
    *)
        die "Unknown command: $COMMAND. Run 'workmode help' for usage."
        ;;
esac
